<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Optional: Git Internals &mdash; Collaborative distributed version control @ KIT  documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
      <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=949a1ff5" />
      <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css?v=13237357" />
      <link rel="stylesheet" type="text/css" href="../_static/sphinx_lesson.css?v=0c089442" />
      <link rel="stylesheet" type="text/css" href="../_static/term_role_formatting.css?v=4194e21c" />
      <link rel="stylesheet" type="text/css" href="../_static/sphinx_rtd_theme_ext_color_contrast.css?v=8e8ea19f" />
      <link rel="stylesheet" type="text/css" href="../_static/tabs.css?v=a5c4661c" />

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js?v=5d32c60e"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../_static/documentation_options.js?v=187304be"></script>
        <script src="../_static/doctools.js?v=9a2dae69"></script>
        <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
        <script src="../_static/copybutton.js?v=582ca9e2"></script>
        <script src="../_static/minipres.js?v=a0d29692"></script>
        <script>let toggleHintShow = 'Click to show';</script>
        <script>let toggleHintHide = 'Click to hide';</script>
        <script>let toggleOpenOnPrint = 'true';</script>
        <script src="../_static/togglebutton.js?v=4a39c7ea"></script>
        <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
        <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
        <script data-domain="coderefinery.github.io" defer="defer" src="https://plausible.cs.aalto.fi/js/script.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex/" />
    <link rel="search" title="Search" href="../search/" />
    <link rel="next" title="Operating on Branches" href="../branches/" />
    <link rel="prev" title="Inspecting history" href="../archaeology/" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../" class="icon icon-home">
            Collaborative distributed version control @ KIT
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search/" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Episodes</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../commits/">Quick recap on Git Basics: Commits and Branches</a></li>
<li class="toctree-l1"><a class="reference internal" href="../git-states/">Beyond add and commit: undoing mistakes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../archaeology/">Inspecting history</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Optional: Git Internals</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#down-the-rabbit-hole">Down the rabbit hole</a></li>
<li class="toctree-l2"><a class="reference internal" href="#git-is-at-its-core-a-content-addressed-storage-system">Git is at its core a content-addressed storage system</a></li>
<li class="toctree-l2"><a class="reference internal" href="#demo-if-you-add-it-you-don-t-lose-it-for-a-while">Demo: If you add it, you don’t lose it (for a while)</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../branches/">Operating on Branches</a></li>
<li class="toctree-l1"><a class="reference internal" href="../collaboration-concepts/">Concepts around collaboration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../same-repository/">Collaborating within the same repository: issues and pull requests</a></li>
<li class="toctree-l1"><a class="reference internal" href="../code-review/">Code review demo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../forking-workflow/">How to contribute changes to repositories that belong to others</a></li>
<li class="toctree-l1"><a class="reference internal" href="../interrupted/">Interrupted work</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tooling/">Tooling and practices that you might find useful</a></li>
<li class="toctree-l1"><a class="reference internal" href="../merge-tooling/">Merge and beyond</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../reference/">Quick reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../exercises/">List of exercises</a></li>
<li class="toctree-l1"><a class="reference internal" href="../guide/">Instructor guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../guide/#instructor-guide-original">Instructor guide - original</a></li>
<li class="toctree-l1"><a class="reference external" href="https://mmesiti.github.io/git-intermediate/lesson.pdf">PDF version</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">About</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://coderefinery.org/lessons/core/">All lessons</a></li>
<li class="toctree-l1"><a class="reference external" href="https://coderefinery.org/">CodeRefinery</a></li>
<li class="toctree-l1"><a class="reference external" href="https://coderefinery.org/lessons/reusing/">Reusing</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../">Collaborative distributed version control @ KIT</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Optional: Git Internals</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/mmesiti/git-intermediate/blob/main/content/internals.md" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="optional-git-internals">
<h1>Optional: Git Internals<a class="headerlink" href="#optional-git-internals" title="Link to this heading"></a></h1>
<div class="admonition-objectives objectives admonition" id="objectives-0">
<p class="admonition-title">Objectives</p>
<ul class="simple">
<li><p>Understand what is easy to do with git, and what is not easy</p></li>
</ul>
</div>
<div class="admonition-instructor-note instructor-note admonition" id="instructor-note-0">
<p class="admonition-title">Instructor note</p>
<ul class="simple">
<li><p>15 min teaching/type-along</p></li>
<li><p>15 min exercise</p></li>
</ul>
</div>
<section id="down-the-rabbit-hole">
<h2>Down the rabbit hole<a class="headerlink" href="#down-the-rabbit-hole" title="Link to this heading"></a></h2>
<p>When usually working with Git,
<strong>you will never need to go inside .git</strong>,
but in this exercise we will
in order to learn about</p>
<ul class="simple">
<li><p>how branches are implemented in Git,
and how to use them freely</p></li>
<li><p>how you can avoid losing data with Git.</p></li>
</ul>
<div class="admonition-prerequisites prerequisites admonition" id="prerequisites-0">
<p class="admonition-title">Prerequisites</p>
<p>For this exercise create a new repository and commit a couple of changes.
You can also clone this repository:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/mmesiti/merge-fu.git
</pre></div>
</div>
</div>
<p>Now that we’ve made a couple of commits let us look at what is happening under
the hood.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span><span class="nb">cd</span><span class="w"> </span>.git
<span class="gp">$ </span>ls<span class="w"> </span>-l

<span class="go">drwxr-xr-x   - user 25 Aug 15:51 branches</span>
<span class="go">.rw-r--r-- 499 user 25 Aug 15:52 COMMIT_EDITMSG</span>
<span class="go">.rw-r--r--  92 user 25 Aug 15:51 config</span>
<span class="go">.rw-r--r--  73 user 25 Aug 15:51 description</span>
<span class="go">.rw-r--r--  21 user 25 Aug 15:51 HEAD</span>
<span class="go">drwxr-xr-x   - user 25 Aug 15:51 hooks</span>
<span class="go">.rw-r--r-- 137 user 25 Aug 15:52 index</span>
<span class="go">drwxr-xr-x   - user 25 Aug 15:51 info</span>
<span class="go">drwxr-xr-x   - user 25 Aug 15:52 logs</span>
<span class="go">drwxr-xr-x   - user 25 Aug 15:52 objects</span>
<span class="go">drwxr-xr-x   - user 25 Aug 15:51 refs</span>
</pre></div>
</div>
<p>Git stores everything under the .git folder in your repository.<br />
We will have a look at the <code class="docutils literal notranslate"><span class="pre">objects</span></code> and the <code class="docutils literal notranslate"><span class="pre">refs</span></code> directories.</p>
<p>In the <a class="reference internal" href="../reference/#term-object"><span class="xref std std-term">objects</span></a> directory we find, among others, 3 kinds of objects:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">commit</span></code>s: These represent the commits we have made with <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">commit</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">blob</span></code>s: These represent snapshots of all the files we have ever added to the repo
with <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">add</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">tree</span></code>s: These represent directories containing the files we have added,
and reference other <code class="docutils literal notranslate"><span class="pre">tree</span></code>s (subdirectories) and <code class="docutils literal notranslate"><span class="pre">blob</span></code>s (files that we have added).</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">commit</span></code> objects contain information about the author and the commit message,
and every <code class="docutils literal notranslate"><span class="pre">commit</span></code> object references a single <code class="docutils literal notranslate"><span class="pre">tree</span></code> object.</p>
<p><strong>All objects are named as the SHA-1 hash (a 40-character hexadecimal string)
that is computed on their content.</strong><br />
This means that all objects are <em>immutable</em>.</p>
<figure class="align-default" id="id1">
<a class="reference internal image-reference" href="../_images/commit-and-tree.png"><img alt="A commit inside Git" src="../_images/commit-and-tree.png" style="width: 100%;" /></a>
<figcaption>
<p><span class="caption-text">States of a Git repository. Image from the <a class="reference external" href="https://git-scm.com/book/">Pro Git book</a>. License CC BY 3.0.</span><a class="headerlink" href="#id1" title="Link to this image"></a></p>
</figcaption>
</figure>
<div class="admonition-changes-and-their-effect-files-and-commits exercise important admonition" id="exercise-0">
<p class="admonition-title">Changes and their effect: files and commits</p>
<p>Refer to the figure above, and discuss:
which SHA-1 hashes would change in the diagram if:</p>
<ul class="simple">
<li><p>the content of the first file is changed,</p></li>
<li><p>we recreate a commit with another message or author</p></li>
<li><p>we recreate a commit with the same message or author</p></li>
</ul>
<p>Is it possibe to have multiple commits refer to the same tree?
What happens when you use <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">revert</span></code>?</p>
<div class="admonition-solution solution important dropdown admonition" id="solution-0">
<p class="admonition-title">Solution</p>
<p>When reverting a commit B that happens after a commit A,
the new commit will point at the same tree as A.</p>
</div>
</div>
<p>Once you have several commits,
each commit object also links
to the hash of the previous commit(s)
(there is more than one previous commit for for merge commits).
The commits form a <a class="reference external" href="http://eagain.net/articles/git-for-computer-scientists/">directed acyclic graph</a>
(do not worry if the term is not familiar).</p>
<figure class="align-default" id="id2">
<a class="reference internal image-reference" href="../_images/commits-and-parents.png"><img alt="A commit and its parents" src="../_images/commits-and-parents.png" style="width: 100%;" /></a>
<figcaption>
<p><span class="caption-text">A commit and its parents. Image from the <a class="reference external" href="https://git-scm.com/book/">Pro Git book</a>. License CC BY 3.0.</span><a class="headerlink" href="#id2" title="Link to this image"></a></p>
</figcaption>
</figure>
<div class="admonition-changes-and-their-effect-changing-history discussion important admonition" id="discussion-0">
<p class="admonition-title">Changes and their effect: changing history</p>
<p>Refer to the figure above, and discuss:
which SHA-1 hashes would change in the diagram if:</p>
<ul class="simple">
<li><p>The the 3rd commit were changed</p></li>
<li><p>The 2nd commit were changed</p></li>
</ul>
</div>
</section>
<section id="git-is-at-its-core-a-content-addressed-storage-system">
<h2>Git is at its core a content-addressed storage system<a class="headerlink" href="#git-is-at-its-core-a-content-addressed-storage-system" title="Link to this heading"></a></h2>
<ul class="simple">
<li><p>CAS: <a class="reference external" href="https://en.wikipedia.org/wiki/Content-addressable_storage">“mechanism for storing information that can be retrieved based on its content, not its storage location”</a></p></li>
<li><p>Content address is the content digest (SHA-1 checksum)</p></li>
<li><p>Stored data does not change,
so when we modify commits or add new version of the files,
we always create new objects.
Git doesn’t delete the old objects right away,
which is why it is <em>very hard to lose data if you commit it once</em>.</p></li>
</ul>
<div class="admonition-a-look-at-the-objects exercise important admonition" id="exercise-1">
<p class="admonition-title">A look at the objects</p>
<p>Let us poke a bit into raw objects! Start with:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>git<span class="w"> </span>cat-file<span class="w"> </span>-p<span class="w"> </span>HEAD
</pre></div>
</div>
<p>Then explore the <code class="docutils literal notranslate"><span class="pre">tree</span></code> object, then the <code class="docutils literal notranslate"><span class="pre">file</span></code> object, etc. recursively using the hashes you see.</p>
</div>
</section>
<section id="demo-if-you-add-it-you-don-t-lose-it-for-a-while">
<h2>Demo: If you add it, you don’t lose it (for a while)<a class="headerlink" href="#demo-if-you-add-it-you-don-t-lose-it-for-a-while" title="Link to this heading"></a></h2>
<p>A common way to (apparently) lose work
is to use <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">add</span></code> indiscriminately.</p>
<p>You make some changes to a file,
(let us call this version A)
you <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">add</span></code> them,
then you make some other changes
(let us call this version B)
and you <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">add</span></code> those again.</p>
<p>Now version A is apparently lost,
and if we realize that we need it back
we typically click nervously on the “undo” arrow of our editor.</p>
<p>But fear not! Try this.</p>
<ol class="arabic">
<li><p>Create a file named <code class="docutils literal notranslate"><span class="pre">test-add</span></code> with the following command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">echo</span> <span class="s1">&#39;Once a file has been git added, it is hard to lose!&#39;</span> <span class="o">&gt;</span> <span class="n">test</span><span class="o">-</span><span class="n">add</span>
</pre></div>
</div>
</li>
<li><p>Add it to the repository</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>git<span class="w"> </span>add<span class="w"> </span>test-add
</pre></div>
</div>
</li>
<li><p>Now change the content of the file to be</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Ops</span>
</pre></div>
</div>
</li>
<li><p>And repeat the add command</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>git<span class="w"> </span>add<span class="w"> </span>test-add
</pre></div>
</div>
</li>
<li><p>Apparently we have lost the previous version of the file.
But it is actually there, stored in a <em>dangling</em> blob object
(which is not referenced,
even indirectly,
by any <code class="docutils literal notranslate"><span class="pre">ref</span></code>)
We can see this with the command <code class="docutils literal notranslate"><span class="pre">fsck</span></code>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>git<span class="w"> </span>fsck
<span class="go">Checking object directories: 100% (256/256), done.</span>
<span class="go">dangling blob dc3b15f60045eea7a87639436ed75021130579e0</span>
</pre></div>
</div>
<p>We can see the content of that blob
by passing its hash (shortened for convenience)
to the <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">cat-file</span> <span class="pre">-p</span></code> command:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>git<span class="w"> </span>cat-file<span class="w"> </span>-p<span class="w"> </span>dc3b
<span class="go">Once a file has been git added, it is hard to lose!</span>
</pre></div>
</div>
</li>
</ol>
<p>Deletion of dangling objects is done by a <em>garbage collector</em>
that might be triggered automatically by some commands.</p>
<div class="admonition-discussion discussion important admonition" id="discussion-1">
<p class="admonition-title">Discussion</p>
<p>Discuss the findings with other course participants.</p>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../archaeology/" class="btn btn-neutral float-left" title="Inspecting history" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../branches/" class="btn btn-neutral float-right" title="Operating on Branches" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright CodeRefinery team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>